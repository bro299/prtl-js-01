<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Dashboard - Portal Data DPR RI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'count-up': 'countUp 2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        countUp: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    },
                    screens: {
                        'xs': '320px',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <!-- Navigation - Mobile First -->
    <nav class="bg-white/80 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-indigo-100">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <i class="fas fa-chart-bar text-xl sm:text-2xl text-indigo-600"></i>
                    <h1 class="text-lg sm:text-xl font-bold text-gray-800 truncate">Dashboard DPR RI</h1>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-200 text-sm sm:text-base">
                        <i class="fas fa-search mr-1 sm:mr-2"></i>
                        <span class="hidden xs:inline">Pencarian</span>
                    </a>
                    <a href="dashboard.html" class="text-indigo-600 hover:text-indigo-800 font-medium transition-colors duration-200 text-sm sm:text-base">
                        <i class="fas fa-chart-bar mr-1 sm:mr-2"></i>
                        <span class="hidden xs:inline">Dashboard</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header - Mobile Optimized -->
    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
        <div class="text-center animate-slide-up">
            <h1 class="text-2xl xs:text-3xl sm:text-4xl font-bold text-gray-800 mb-3 sm:mb-4">
                ðŸ“Š Dashboard Analytics DPR RI
            </h1>
            <p class="text-base sm:text-xl text-gray-600 mb-4 sm:mb-8 px-2">
                Visualisasi Data Anggota Dewan Perwakilan Rakyat
            </p>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12">
        <div class="text-center">
            <div class="inline-flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-b-2 border-indigo-600"></div>
                <span class="text-base sm:text-xl text-gray-600">Memuat data dashboard...</span>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="hidden max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 pb-6 sm:pb-12">
        
        <!-- Stats Cards - Mobile Optimized -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-6 border border-white/30 animate-fade-in">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wide">Total Anggota</p>
                        <p id="totalMembers" class="text-lg sm:text-2xl font-bold text-indigo-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-indigo-100 rounded-full p-2 sm:p-3 w-8 h-8 sm:w-auto sm:h-auto flex items-center justify-center">
                        <i class="fas fa-users text-indigo-600 text-sm sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-6 border border-white/30 animate-fade-in">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wide">Total Fraksi</p>
                        <p id="totalFraksi" class="text-lg sm:text-2xl font-bold text-green-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-2 sm:p-3 w-8 h-8 sm:w-auto sm:h-auto flex items-center justify-center">
                        <i class="fas fa-flag text-green-600 text-sm sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-6 border border-white/30 animate-fade-in">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wide">Total Partai</p>
                        <p id="totalPartai" class="text-lg sm:text-2xl font-bold text-purple-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-2 sm:p-3 w-8 h-8 sm:w-auto sm:h-auto flex items-center justify-center">
                        <i class="fas fa-building text-purple-600 text-sm sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-6 border border-white/30 animate-fade-in">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wide">Rata-rata Usia</p>
                        <p id="avgAge" class="text-lg sm:text-2xl font-bold text-orange-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-orange-100 rounded-full p-2 sm:p-3 w-8 h-8 sm:w-auto sm:h-auto flex items-center justify-center">
                        <i class="fas fa-calendar text-orange-600 text-sm sm:text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Comparison Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
    <!-- Gender Distribution Pie Chart -->
    <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
            <i class="fas fa-venus-mars mr-2 sm:mr-3 text-green-600"></i>
            <span class="text-sm sm:text-base">Distribusi Gender (Estimasi)</span>
        </h3>
        <div class="relative h-64 sm:h-80">
            <canvas id="genderChart"></canvas>
        </div>
    </div>

    <!-- Province Distribution Chart -->
    <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
            <i class="fas fa-map-marked-alt mr-2 sm:mr-3 text-blue-600"></i>
            <span class="text-sm sm:text-base">Top 10 Provinsi</span>
        </h3>
        <div class="relative h-64 sm:h-80">
            <canvas id="provinceChart"></canvas>
        </div>
    </div>
</div>

        <!-- Charts Row 1 - Mobile Optimized -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
            <!-- Pendidikan Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-graduation-cap mr-2 sm:mr-3 text-indigo-600"></i>
                    <span class="text-sm sm:text-base">Distribusi Pendidikan Terakhir</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="educationChart"></canvas>
                </div>
            </div>

            <!-- Fraksi Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-flag mr-2 sm:mr-3 text-green-600"></i>
                    <span class="text-sm sm:text-base">Distribusi per Fraksi</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="fraksiChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 - Mobile Optimized -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
            <!-- Agama Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-pray mr-2 sm:mr-3 text-purple-600"></i>
                    <span class="text-sm sm:text-base">Distribusi Agama</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="agamaChart"></canvas>
                </div>
            </div>

            <!-- Usia Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 sm:mr-3 text-orange-600"></i>
                    <span class="text-sm sm:text-base">Distribusi Usia</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="usiaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Real-time Search Section -->
<div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in mb-6 sm:mb-8">
    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-search mr-2 sm:mr-3 text-purple-600"></i>
        <span class="text-sm sm:text-base">Pencarian Cepat</span>
    </h3>
    
    <div class="relative">
        <input 
            type="text" 
            id="dashboardSearch" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
            placeholder="Ketik nama anggota DPR..."
            autocomplete="off"
        >
        <div id="quickSearchResults" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto mt-1">
            <!-- Quick search results -->
        </div>
    </div>
    
    <div class="flex gap-2 mt-3">
        <button id="randomMember" class="px-3 sm:px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 text-xs sm:text-sm transition-all">
            <i class="fas fa-random mr-1 sm:mr-2"></i>
            <span class="hidden xs:inline">Anggota </span>Acak
        </button>
        <button id="clearSearch" class="px-3 sm:px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-xs sm:text-sm transition-all">
            <i class="fas fa-times mr-1 sm:mr-2"></i>
            <span class="hidden xs:inline">Clear</span>
        </button>
    </div>
</div>

        <!-- Top Lists - Mobile Optimized -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
            <!-- Top Fraksi -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-trophy mr-2 sm:mr-3 text-yellow-500"></i>
                    <span class="text-sm sm:text-base">Top 5 Fraksi</span>
                </h3>
                <div id="topFraksi" class="space-y-2 sm:space-y-3">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Top Partai -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-medal mr-2 sm:mr-3 text-blue-500"></i>
                    <span class="text-sm sm:text-base">Top 5 Partai</span>
                </h3>
                <div id="topPartai" class="space-y-2 sm:space-y-3">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Education Stats -->
            <div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in md:col-span-2 lg:col-span-1">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                    <i class="fas fa-book mr-2 sm:mr-3 text-indigo-500"></i>
                    <span class="text-sm sm:text-base">Statistik Pendidikan</span>
                </h3>
                <div id="educationStats" class="space-y-2 sm:space-y-3">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Data Export & Download Section -->
<div class="bg-white/70 backdrop-blur-sm rounded-lg sm:rounded-xl shadow-lg p-4 sm:p-6 border border-white/30 animate-fade-in mt-6 sm:mt-8">
    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-download mr-2 sm:mr-3 text-indigo-600"></i>
        <span class="text-sm sm:text-base">Export Data</span>
    </h3>
    
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
        <button id="exportJSON" class="flex items-center justify-center px-3 sm:px-4 py-2 sm:py-3 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg transition-colors text-sm">
            <i class="fas fa-code mr-2"></i>
            <span>Export JSON</span>
        </button>
        
        <button id="exportCSV" class="flex items-center justify-center px-3 sm:px-4 py-2 sm:py-3 bg-green-100 hover:bg-green-200 text-green-800 rounded-lg transition-colors text-sm">
            <i class="fas fa-table mr-2"></i>
            <span>Export CSV</span>
        </button>
        
        <button id="generateReport" class="flex items-center justify-center px-3 sm:px-4 py-2 sm:py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-colors text-sm">
            <i class="fas fa-file-pdf mr-2"></i>
            <span>Generate Report</span>
        </button>
    </div>
    
    <div id="exportProgress" class="hidden mt-4">
        <div class="bg-gray-200 rounded-full h-2">
            <div id="exportProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-xs sm:text-sm text-gray-600 mt-2" id="exportStatus">Preparing export...</p>
    </div>
</div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 sm:py-8 mt-8 sm:mt-12">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 text-center">
            <p class="text-base sm:text-lg mb-2">&copy; 2025 Dashboard DPR RI - Express.js Version</p>
            <p class="text-sm sm:text-base text-gray-400">
                Real-time Analytics â€¢ Powered by Chart.js & Tailwind CSS
            </p>
        </div>
    </footer>

    <script>
        // Dashboard JavaScript for analytics and charts

class DPRDashboard {
    constructor() {
        this.loading = document.getElementById('loading');
        this.dashboardContent = document.getElementById('dashboardContent');
        this.charts = {};
        
        this.initDashboard();
    }

    async initDashboard() {
        try {
            this.showLoading();
            const stats = await this.fetchStats();
            this.hideLoading();
            
            this.updateStatsCards(stats);
            this.createCharts(stats);
            this.updateTopLists(stats);
            
        } catch (error) {
            console.error('Dashboard error:', error);
            this.hideLoading();
            this.showError('Gagal memuat data dashboard');
        }
    }

    async fetchStats() {
        const response = await fetch('/api/stats');
        if (!response.ok) {
            throw new Error('Failed to fetch statistics');
        }
        const data = await response.json();
        return data.data;
    }

    showLoading() {
        this.loading.classList.remove('hidden');
        this.dashboardContent.classList.add('hidden');
    }

    hideLoading() {
        this.loading.classList.add('hidden');
        this.dashboardContent.classList.remove('hidden');
    }

    showError(message) {
        this.loading.innerHTML = `
            <div class="text-center">
                <div class="bg-red-100 border border-red-300 text-red-700 px-4 sm:px-6 py-3 sm:py-4 rounded-xl">
                    <i class="fas fa-exclamation-triangle text-xl sm:text-2xl mb-2"></i>
                    <p class="text-base sm:text-lg">${message}</p>
                </div>
            </div>
        `;
    }

    updateStatsCards(stats) {
        // Animate count up
        this.animateCountUp('totalMembers', stats.total[0]?.count || 0);
        this.animateCountUp('totalFraksi', stats.byFraksi.length);
        this.animateCountUp('totalPartai', stats.byPartai.length);
        
        // Calculate average age
        const avgAge = this.calculateAverageAge(stats.byUsia);
        this.animateCountUp('avgAge', avgAge, ' th');
    }

    animateCountUp(elementId, targetValue, suffix = '') {
        const element = document.getElementById(elementId);
        const duration = 2000; // 2 seconds
        const startTime = performance.now();
        const startValue = 0;

        const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOut);
            
            element.textContent = currentValue + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };
        
        requestAnimationFrame(animate);
    }

    calculateAverageAge(usiaData) {
        let totalAge = 0;
        let totalCount = 0;
        
        usiaData.forEach(item => {
            const kategori = item.kategori_usia;
            const count = item.count;
            
            let avgAge = 0;
            if (kategori.includes('30-40')) avgAge = 35;
            else if (kategori.includes('41-50')) avgAge = 45;
            else if (kategori.includes('51-60')) avgAge = 55;
            else if (kategori.includes('Di atas 60')) avgAge = 65;
            else if (kategori.includes('Di bawah 30')) avgAge = 25;
            
            totalAge += avgAge * count;
            totalCount += count;
        });
        
        return totalCount > 0 ? Math.round(totalAge / totalCount) : 0;
    }

    createCharts(stats) {
    this.createEducationChart(stats.byPendidikan);
    this.createFraksiChart(stats.byFraksi);
    this.createAgamaChart(stats.byAgama);
    this.createUsiaChart(stats.byUsia);
    this.createGenderChart(stats.total[0]?.count);  // Add this line
    this.createProvinceChart();                      // Add this line
}

    createEducationChart(data) {
        const ctx = document.getElementById('educationChart').getContext('2d');
        
        // Group education levels
        const educationGroups = {
            'SMA/Sederajat': 0,
            'D1/D2/D3': 0,
            'S1': 0,
            'S2': 0,
            'S3': 0,
            'Lainnya': 0
        };

        data.forEach(item => {
            const pendidikan = (item.pendidikan_terakhir || '').toUpperCase();
            if (pendidikan.includes('SMA') || pendidikan.includes('SMK') || pendidikan.includes('ALIYAH')) {
                educationGroups['SMA/Sederajat'] += item.count;
            } else if (pendidikan.includes('DIPLOMA') || pendidikan.includes('D1') || pendidikan.includes('D2') || pendidikan.includes('D3')) {
                educationGroups['D1/D2/D3'] += item.count;
            } else if (pendidikan.includes('S1')) {
                educationGroups['S1'] += item.count;
            } else if (pendidikan.includes('S2')) {
                educationGroups['S2'] += item.count;
            } else if (pendidikan.includes('S3')) {
                educationGroups['S3'] += item.count;
            } else if (item.pendidikan_terakhir && item.pendidikan_terakhir !== '') {
                educationGroups['Lainnya'] += item.count;
            }
        });

        const labels = Object.keys(educationGroups);
        const values = Object.values(educationGroups);

        this.charts.education = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: window.innerWidth < 640 ? 10 : 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed * 100) / total).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    createFraksiChart(data) {
        const ctx = document.getElementById('fraksiChart').getContext('2d');
        
        // Take top 6 fraksi for mobile, top 8 for desktop
        const maxItems = window.innerWidth < 640 ? 6 : 8;
        const topFraksi = data.slice(0, maxItems);
        
        this.charts.fraksi = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topFraksi.map(item => this.truncateLabel(item.fraksi, window.innerWidth < 640 ? 10 : 15)),
                datasets: [{
                    label: 'Jumlah Anggota',
                    data: topFraksi.map(item => item.count),
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: window.innerWidth < 640 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: window.innerWidth < 640 ? 90 : 45,
                            font: {
                                size: window.innerWidth < 640 ? 9 : 11
                            }
                        }
                    }
                }
            }
        });
    }

    createAgamaChart(data) {
        const ctx = document.getElementById('agamaChart').getContext('2d');
        
        this.charts.agama = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(item => item.agama || 'Tidak Diketahui'),
                datasets: [{
                    data: data.map(item => item.count),
                    backgroundColor: [
                        '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#F97316'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: window.innerWidth < 640 ? 10 : 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed * 100) / total).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    createUsiaChart(data) {
        const ctx = document.getElementById('usiaChart').getContext('2d');
        
        // Sort by age order
        const sortedData = data.sort((a, b) => {
            const order = {
                'Di bawah 30': 1,
                '30-40 tahun': 2,
                '41-50 tahun': 3,
                '51-60 tahun': 4,
                'Di atas 60': 5,
                'Tidak diketahui': 6
            };
            return (order[a.kategori_usia] || 7) - (order[b.kategori_usia] || 7);
        });
        
        this.charts.usia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedData.map(item => window.innerWidth < 640 ? 
                    item.kategori_usia.replace(' tahun', '') : item.kategori_usia),
                datasets: [{
                    label: 'Jumlah Anggota',
                    data: sortedData.map(item => item.count),
                    backgroundColor: [
                        '#8B5CF6', '#06B6D4', '#10B981', '#F59E0B', '#EF4444', '#6B7280'
                    ],
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: window.innerWidth < 640 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: window.innerWidth < 640 ? 90 : 45,
                            font: {
                                size: window.innerWidth < 640 ? 9 : 11
                            }
                        }
                    }
                }
            }
        });
    }

    updateTopLists(stats) {
        this.updateTopFraksi(stats.byFraksi.slice(0, 5));
        this.updateTopPartai(stats.byPartai.slice(0, 5));
        this.updateEducationStats(stats.byPendidikan);
    }

    updateTopFraksi(data) {
        const container = document.getElementById('topFraksi');
        const total = data.reduce((sum, item) => sum + item.count, 0);
        
        container.innerHTML = data.map((item, index) => {
            const percentage = ((item.count / total) * 100).toFixed(1);
            const colors = ['bg-yellow-500', 'bg-gray-400', 'bg-amber-600', 'bg-blue-500', 'bg-green-500'];
            const maxLength = window.innerWidth < 640 ? 12 : 20;
            
            return `
                <div class="flex items-center justify-between p-2 sm:p-3 bg-white rounded-lg shadow-sm border animate-slide-up" style="animation-delay: ${index * 100}ms">
                    <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full ${colors[index]} flex items-center justify-center text-white font-bold text-xs sm:text-sm flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-800 text-xs sm:text-sm truncate" title="${item.fraksi}">${this.truncateLabel(item.fraksi, maxLength)}</p>
                            <p class="text-xs text-gray-500">${percentage}%</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-bold text-gray-800 text-sm sm:text-base">${item.count}</p>
                        <p class="text-xs text-gray-500">anggota</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateTopPartai(data) {
        const container = document.getElementById('topPartai');
        const total = data.reduce((sum, item) => sum + item.count, 0);
        
        container.innerHTML = data.map((item, index) => {
            const percentage = ((item.count / total) * 100).toFixed(1);
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 'bg-indigo-500'];
            const maxLength = window.innerWidth < 640 ? 10 : 15;
            
            return `
                <div class="flex items-center justify-between p-2 sm:p-3 bg-white rounded-lg shadow-sm border animate-slide-up" style="animation-delay: ${index * 100}ms">
                    <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full ${colors[index]} flex items-center justify-center text-white font-bold text-xs sm:text-sm flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-800 text-xs sm:text-sm truncate" title="${item.partai}">${this.truncateLabel(item.partai, maxLength)}</p>
                            <p class="text-xs text-gray-500">${percentage}%</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-bold text-gray-800 text-sm sm:text-base">${item.count}</p>
                        <p class="text-xs text-gray-500">anggota</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateEducationStats(data) {
        const container = document.getElementById('educationStats');
        
        // Group and calculate education statistics
        const educationGroups = {
            'S3': 0,
            'S2': 0,
            'S1': 0,
            'Diploma': 0,
            'SMA/Sederajat': 0
        };

        data.forEach(item => {
            const pendidikan = (item.pendidikan_terakhir || '').toUpperCase();
            if (pendidikan.includes('S3')) {
                educationGroups['S3'] += item.count;
            } else if (pendidikan.includes('S2')) {
                educationGroups['S2'] += item.count;
            } else if (pendidikan.includes('S1')) {
                educationGroups['S1'] += item.count;
            } else if (pendidikan.includes('DIPLOMA') || pendidikan.includes('D1') || pendidikan.includes('D2') || pendidikan.includes('D3')) {
                educationGroups['Diploma'] += item.count;
            } else if (pendidikan.includes('SMA') || pendidikan.includes('SMK')) {
                educationGroups['SMA/Sederajat'] += item.count;
            }
        });

        const total = Object.values(educationGroups).reduce((sum, count) => sum + count, 0);

        container.innerHTML = Object.entries(educationGroups)
            .filter(([_, count]) => count > 0)
            .sort(([,a], [,b]) => b - a)
            .map(([level, count], index) => {
                const percentage = ((count / total) * 100).toFixed(1);
                const icons = {
                    'S3': 'fas fa-user-graduate',
                    'S2': 'fas fa-graduation-cap',
                    'S1': 'fas fa-university',
                    'Diploma': 'fas fa-certificate',
                    'SMA/Sederajat': 'fas fa-school'
                };
                
                return `
                    <div class="flex items-center justify-between p-2 sm:p-3 bg-white rounded-lg shadow-sm border animate-slide-up" style="animation-delay: ${index * 100}ms">
                        <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                                <i class="${icons[level]} text-indigo-600 text-xs sm:text-sm"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="font-medium text-gray-800 text-xs sm:text-sm">${level}</p>
                                <p class="text-xs text-gray-500">${percentage}%</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-gray-800 text-sm sm:text-base">${count}</p>
                            <p class="text-xs text-gray-500">orang</p>
                        </div>
                    </div>
                `;
            }).join('');
    }

          createGenderChart(data) {
    const ctx = document.getElementById('genderChart');
    if (!ctx) return;
    
    // Estimate gender based on name patterns (basic implementation)
    const genderEstimate = this.estimateGenderDistribution(data);
    
    this.charts.gender = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Laki-laki (Est.)', 'Perempuan (Est.)', 'Tidak Pasti'],
            datasets: [{
                data: [genderEstimate.male, genderEstimate.female, genderEstimate.unknown],
                backgroundColor: ['#3B82F6', '#EF4444', '#6B7280'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: window.innerWidth < 640 ? 10 : 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

estimateGenderDistribution(totalMembers) {
    // Simple estimation based on typical Indonesian gender distribution in politics
    // This is a placeholder - in real implementation you'd analyze names or have gender data
    const total = totalMembers || 573;
    return {
        male: Math.floor(total * 0.78),   // ~78% male (typical Indonesian parliament)
        female: Math.floor(total * 0.20), // ~20% female
        unknown: Math.floor(total * 0.02) // ~2% uncertain
    };
}

createProvinceChart(data) {
    const ctx = document.getElementById('provinceChart');
    if (!ctx) return;
    
    // This would need province data from your API
    // For now, create placeholder
    const provinceData = [
        {province: 'Jawa Barat', count: 91},
        {province: 'Jawa Timur', count: 87},
        {province: 'Jawa Tengah', count: 77},
        {province: 'Sumatera Utara', count: 30},
        {province: 'Sumatera Selatan', count: 24},
        {province: 'DKI Jakarta', count: 21},
        {province: 'Sulawesi Selatan', count: 20},
        {province: 'Lampung', count: 18},
        {province: 'Riau', count: 16},
        {province: 'Kalimantan Selatan', count: 14}
    ];
    
    this.charts.province = new Chart(ctx.getContext('2d'), {
        type: 'horizontalBar',
        data: {
            labels: provinceData.map(item => 
                window.innerWidth < 640 ? 
                this.truncateLabel(item.province, 8) : 
                item.province
            ),
            datasets: [{
                label: 'Jumlah Anggota',
                data: provinceData.map(item => item.count),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 10,
                        font: {
                            size: window.innerWidth < 640 ? 9 : 11
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: window.innerWidth < 640 ? 9 : 11
                        }
                    }
                }
            }
        }
    });
}

    truncateLabel(text, maxLength) {
        if (!text) return 'N/A';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength - 3) + '...';
    }
}
         // Additional Features Class
class DashboardFeatures {
    constructor() {
        this.searchTimeout = null;
        this.initAdditionalFeatures();
    }

    initAdditionalFeatures() {
        this.setupQuickSearch();
        this.setupRandomMember();
        this.setupExportFeatures();
        this.setupKeyboardShortcuts();
    }

    setupQuickSearch() {
        const searchInput = document.getElementById('dashboardSearch');
        const resultsDiv = document.getElementById('quickSearchResults');
        const clearBtn = document.getElementById('clearSearch');
        
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.performQuickSearch(e.target.value);
            });

            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv?.contains(e.target)) {
                    resultsDiv?.classList.add('hidden');
                }
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                resultsDiv?.classList.add('hidden');
            });
        }
    }

    async performQuickSearch(query) {
        const resultsDiv = document.getElementById('quickSearchResults');
        
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }

        if (query.length < 2) {
            resultsDiv?.classList.add('hidden');
            return;
        }

        this.searchTimeout = setTimeout(async () => {
            try {
                // Mock search results - replace with actual API call
                const mockResults = [
                    {id: 1, nama: 'Puan Maharani', fraksi: 'PDI Perjuangan', partai: 'PDI-P', dapil: 'Jawa Tengah I'},
                    {id: 2, nama: 'Airlangga Hartarto', fraksi: 'Golkar', partai: 'Golkar', dapil: 'Jawa Timur VII'},
                ].filter(member => 
                    member.nama.toLowerCase().includes(query.toLowerCase())
                );
                
                this.displayQuickSearchResults(mockResults);
            } catch (error) {
                console.error('Quick search error:', error);
            }
        }, 300);
    }

    displayQuickSearchResults(results) {
        const resultsDiv = document.getElementById('quickSearchResults');
        if (!resultsDiv) return;
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="p-3 text-gray-500 text-center text-sm">Tidak ada hasil ditemukan</div>';
        } else {
            const html = results.map(member => `
                <div class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0 transition-colors" onclick="dashboardFeatures.showMemberInfo('${member.id}')">
                    <div class="font-medium text-gray-800 text-sm">${member.nama}</div>
                    <div class="text-xs text-gray-600">${member.fraksi} - ${member.partai}</div>
                    <div class="text-xs text-gray-500">${member.dapil}</div>
                </div>
            `).join('');
            
            resultsDiv.innerHTML = html;
        }
        
        resultsDiv.classList.remove('hidden');
    }

    showMemberInfo(memberId) {
        // Create simple member info modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-md w-full">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-user text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Info Anggota</h3>
                    <p class="text-gray-600 mb-4">Fitur detail akan segera tersedia</p>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.remove(), 5000);
    }

    setupRandomMember() {
        const randomBtn = document.getElementById('randomMember');
        if (randomBtn) {
            randomBtn.addEventListener('click', () => {
                const randomMembers = [
                    'Puan Maharani - PDI Perjuangan',
                    'Airlangga Hartarto - Golkar',
                    'Muhaimin Iskandar - PKB',
                    'Ahmad Muzani - Gerindra',
                    'Sufmi Dasco Ahmad - Gerindra'
                ];
                
                const randomMember = randomMembers[Math.floor(Math.random() * randomMembers.length)];
                this.showRandomMemberModal(randomMember);
            });
        }
    }

    showRandomMemberModal(memberName) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-orange-400 to-red-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-random text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Anggota Terpilih</h3>
                <p class="text-indigo-600 font-semibold mb-4">${memberName}</p>
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                    Tutup
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.remove(), 8000);
    }

    setupExportFeatures() {
        const exportJSON = document.getElementById('exportJSON');
        const exportCSV = document.getElementById('exportCSV');
        const generateReport = document.getElementById('generateReport');

        if (exportJSON) {
            exportJSON.addEventListener('click', () => this.exportData('json'));
        }
        
        if (exportCSV) {
            exportCSV.addEventListener('click', () => this.exportData('csv'));
        }
        
        if (generateReport) {
            generateReport.addEventListener('click', () => this.generateReport());
        }
    }

    async exportData(format) {
        const progressDiv = document.getElementById('exportProgress');
        const progressBar = document.getElementById('exportProgressBar');
        const statusText = document.getElementById('exportStatus');
        
        if (!progressDiv) return;
        
        try {
            progressDiv.classList.remove('hidden');
            this.updateProgress(20, 'Mengambil data...');
            
            // Simulate data processing
            await this.delay(500);
            this.updateProgress(60, 'Memproses data...');
            
            await this.delay(800);
            
            // Create mock data
            const mockData = {
                timestamp: new Date().toISOString(),
                total_members: 573,
                export_format: format,
                note: 'Mock export data for demonstration'
            };
            
            if (format === 'json') {
                this.downloadJSON(mockData, 'dpr_data.json');
            } else {
                this.downloadCSV([mockData], 'dpr_data.csv');
            }
            
            this.updateProgress(100, 'Export selesai!');
            setTimeout(() => progressDiv.classList.add('hidden'), 2000);
            
        } catch (error) {
            statusText.textContent = 'Export gagal: ' + error.message;
            setTimeout(() => progressDiv.classList.add('hidden'), 3000);
        }
    }

    updateProgress(percent, status) {
        const progressBar = document.getElementById('exportProgressBar');
        const statusText = document.getElementById('exportStatus');
        
        if (progressBar) progressBar.style.width = percent + '%';
        if (statusText) statusText.textContent = status;
    }

    downloadJSON(data, filename) {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        this.downloadBlob(blob, filename);
    }

    downloadCSV(data, filename) {
        const csvStr = Object.keys(data[0]).join(',') + '\n' + 
                      data.map(row => Object.values(row).join(',')).join('\n');
        const blob = new Blob([csvStr], { type: 'text/csv' });
        this.downloadBlob(blob, filename);
    }

    downloadBlob(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    generateReport() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-file-pdf text-white text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Generate Report</h3>
                <p class="text-gray-600 mb-4">Fitur generate report akan segera tersedia dengan integrasi backend</p>
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                    Tutup
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.remove(), 5000);
    }

    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K untuk quick search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('dashboardSearch');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            // Escape untuk tutup modal/dropdown
            if (e.key === 'Escape') {
                const quickResults = document.getElementById('quickSearchResults');
                if (quickResults) {
                    quickResults.classList.add('hidden');
                }
                
                // Close any open modals
                const modals = document.querySelectorAll('.fixed.inset-0.z-50');
                modals.forEach(modal => modal.remove());
            }
        });
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Global instance
let dashboardFeatures;

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new DPRDashboard();
    dashboardFeatures = new DashboardFeatures();
});
    
    </script>
</body>
</html>